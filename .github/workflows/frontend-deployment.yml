name: Frontend Deployment

on:
  push:
    branches:
      - team6-yagya

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build application
      working-directory: ./frontend
      run: npm run build
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}

    - name: Deploy to S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        echo "‚òÅÔ∏è Deploying to S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
        aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET_NAME }}/ --delete
        echo "‚úÖ S3 deployment completed"

    - name: Invalidate CloudFront
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        echo "üîÑ Invalidating CloudFront distribution: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
        aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
        echo "‚úÖ CloudFront invalidation initiated"

    - name: Wait for deployment to be ready
      env:
        FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        BACKEND_API_URL: ${{ secrets.BACKEND_API_URL }}
      run: |
        echo "‚è≥ Waiting for CloudFront invalidation to complete..."
        echo "üîç Testing frontend availability..."
        for i in {1..6}; do
          if curl -s -f "${FRONTEND_URL}" > /dev/null; then
            echo "‚úÖ Frontend is accessible!"
            break
          fi
          echo "‚è≥ Attempt $i/6 - waiting 20 seconds..."
          sleep 20
        done
        
        echo "üîç Checking backend API availability..."
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_API_URL}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Backend API is healthy! (HTTP $HTTP_CODE)"
            break
          else
            echo "‚è≥ Backend not ready (HTTP $HTTP_CODE). Attempt $i/10 - waiting 15 seconds..."
            sleep 15
          fi
        done

    - name: Install Cypress dependencies
      working-directory: ./e2e-tests
      run: npm ci

    - name: Run Cypress E2E Tests
      working-directory: ./e2e-tests
      env:
        CYPRESS_BASE_URL: ${{ secrets.FRONTEND_URL }}
        CYPRESS_API_URL: ${{ secrets.BACKEND_API_URL }}
      run: |
        echo "üéØ Starting E2E tests with optimized configuration..."
        echo "Frontend URL: ${CYPRESS_BASE_URL}"
        echo "Backend URL: ${CYPRESS_API_URL}"
        
        # Run Cypress with optimized settings for faster CI execution
        npm run cy:run -- \
          --config video=false,screenshotOnRunFailure=false \
          --config defaultCommandTimeout=8000,requestTimeout=10000 \
          --config viewportWidth=1280,viewportHeight=720 \
          --browser electron \
          --headless

    - name: Upload Cypress Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: e2e-tests/cypress/screenshots

    - name: Upload Cypress Videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-videos
        path: e2e-tests/cypress/videos

    - name: Send Slack notification on success
      if: success()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        BACKEND_API_URL: ${{ secrets.BACKEND_API_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"‚úÖ Frontend Deployment & E2E Tests Successful! üéâ\\nüìç Branch: ${GITHUB_REF#refs/heads/}\\nüåê Frontend: ${FRONTEND_URL}\\nüîó Backend: ${BACKEND_API_URL}\\n‚ú® New Feature: User Statistics Dashboard added!\"}" \
        "${SLACK_WEBHOOK_URL}"

    - name: Send Slack notification on failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"‚ùå Frontend Deployment or E2E Tests Failed!\\nüìç Branch: ${GITHUB_REF#refs/heads/}\\nüîç Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\nüì∏ Screenshots and videos uploaded to artifacts\"}" \
        "${SLACK_WEBHOOK_URL}"