version: 0.2

env:
  variables:
    NODE_VERSION: "20"
    AWS_DEFAULT_REGION: "us-east-1"
  parameter-store:
    DB_HOST: "/cicd-workshop/test-db-host"
    DB_USER: "/cicd-workshop/test-db-user" 
    DB_PASSWORD: "/cicd-workshop/test-db-password"
    DB_NAME: "/cicd-workshop/test-db-name"
    SLACK_WEBHOOK_URL: "/cicd-workshop/slack-webhook-url"
    ECR_REGISTRY: "/cicd-workshop/ecr-registry"
    ECR_REPOSITORY: "/cicd-workshop/ecr-repository"
    EC2_INSTANCE_ID: "/cicd-workshop/ec2-instance-id"

phases:
  install:
    runtime-versions:
      nodejs: 20
      docker: 20
    commands:
      - echo "ğŸš€ Starting Backend CodePipeline Build..."
      - echo "ğŸ“… Build started on `date`"
      - echo "ğŸ³ Docker version:"
      - docker --version
      - echo "ğŸ“¦ Node.js version:"
      - node --version
      - npm --version

  pre_build:
    commands:
      - echo "ğŸ“‹ Pre-build phase started"
      - cd backend
      
      # Install dependencies
      - echo "ğŸ“¦ Installing backend dependencies..."
      - npm ci
      
      # Run unit tests first (fast feedback)
      - echo "ğŸ§ª Running unit tests..."
      - npm run test:unit
      
      # Start PostgreSQL for integration tests
      - echo "ğŸ˜ Starting PostgreSQL service..."
      - |
        docker run -d \
          --name postgres-test \
          -e POSTGRES_PASSWORD=testpassword \
          -e POSTGRES_USER=testuser \
          -e POSTGRES_DB=testdb \
          -p 5432:5432 \
          postgres:13
      
      # Wait for PostgreSQL to be ready
      - echo "â³ Waiting for PostgreSQL to be ready..."
      - |
        for i in {1..30}; do
          if docker exec postgres-test pg_isready -U testuser; then
            echo "âœ… PostgreSQL is ready!"
            break
          fi
          echo "â³ Attempt $i/30 - waiting 3 seconds..."
          sleep 3
        done
      
      # Run database migrations
      - echo "ğŸ“‹ Running database migrations..."
      - export NODE_ENV=test
      - export DB_HOST=localhost
      - export DB_PORT=5432
      - export DB_USER=testuser
      - export DB_PASSWORD=testpassword
      - export DB_NAME=testdb
      - npm run migrate
      
      # Run integration tests
      - echo "ğŸ”— Running integration tests..."
      - npm run test:integration
      
      # Cleanup test database
      - echo "ğŸ§¹ Cleaning up test database..."
      - docker stop postgres-test || true
      - docker rm postgres-test || true

  build:
    commands:
      - echo "ğŸ—ï¸ Build phase started"
      - cd backend
      
      # Build Docker image
      - echo "ğŸ³ Building Docker image..."
      - echo "ğŸ“ ECR Registry: $ECR_REGISTRY"
      - echo "ğŸ“¦ Repository: $ECR_REPOSITORY"
      - echo "ğŸ·ï¸ Tag: $CODEBUILD_RESOLVED_SOURCE_VERSION"
      
      - IMAGE_TAG=$CODEBUILD_RESOLVED_SOURCE_VERSION
      - IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
      - echo "ğŸ¯ Full image URI: $IMAGE_URI"
      
      # Login to ECR
      - echo "ğŸ” Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
      
      # Build and tag image
      - echo "ğŸ”¨ Building Docker image..."
      - docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
      - docker tag $ECR_REPOSITORY:$IMAGE_TAG $IMAGE_URI
      
      # Push to ECR
      - echo "ğŸ“¤ Pushing image to ECR..."
      - docker push $IMAGE_URI
      
      # Deploy to EC2
      - echo "ğŸš€ Deploying to EC2..."
      - |
        aws ssm send-command \
          --instance-ids $EC2_INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"ğŸ”„ Updating backend container...\"",
            "aws ecr get-login-password --region '$AWS_DEFAULT_REGION' | docker login --username AWS --password-stdin '$ECR_REGISTRY'",
            "docker pull '$IMAGE_URI'",
            "docker stop backend-container || true",
            "docker rm backend-container || true", 
            "docker run -d --name backend-container --network backend -p 3001:3001 -e NODE_ENV=production '$IMAGE_URI'",
            "echo \"âœ… Backend deployment completed!\""
          ]' \
          --region $AWS_DEFAULT_REGION

  post_build:
    commands:
      - echo "ğŸ“Š Post-build phase started"
      - cd backend
      
      # Generate deployment summary
      - echo "ğŸ“‹ Deployment Summary:"
      - echo "======================"
      - echo "âœ… Unit Tests: Passed"
      - echo "âœ… Integration Tests: Passed"
      - echo "âœ… Docker Build: Successful"
      - echo "âœ… ECR Push: Completed"
      - echo "âœ… EC2 Deployment: Initiated"
      - echo "ğŸ³ Image: $IMAGE_URI"
      - echo "ğŸ“… Completed: `date`"
      
      # Send Slack notification
      - |
        if [ ! -z "$SLACK_WEBHOOK_URL" ]; then
          echo "ğŸ“¢ Sending Slack notification..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… Backend CodePipeline Deployment Successful! ğŸš€\\nğŸ“ Branch: ${CODEBUILD_SOURCE_VERSION}\\nğŸ§ª Tests: All Passed\\nğŸ³ Image: ${IMAGE_URI}\\nğŸ“… Time: $(date)\"}" \
            $SLACK_WEBHOOK_URL
        else
          echo "âš ï¸ Slack webhook not configured"
        fi

artifacts:
  files:
    - '**/*'
  name: backend-build-artifacts
  
cache:
  paths:
    - 'backend/node_modules/**/*'
