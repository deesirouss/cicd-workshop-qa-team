version: 0.2

env:
  variables:
    NODE_VERSION: "20"
  parameter-store:
    SLACK_WEBHOOK_URL: "/cicd-workshop/slack-webhook-url"
    BACKEND_API_URL: "/cicd-workshop/backend-api-url"
    FRONTEND_URL: "/cicd-workshop/frontend-url"

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "ğŸ“¦ Installing dependencies..."
      - cd e2e-tests && npm ci
      
  pre_build:
    commands:
      - echo "ğŸ” Pre-build checks..."
      - echo "Backend URL: $BACKEND_API_URL"
      - echo "Frontend URL: $FRONTEND_URL"
      
      # Wait for backend to be ready
      - echo "â³ Waiting for backend to be ready..."
      - |
        for i in {1..30}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_API_URL/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Backend is healthy! (HTTP $HTTP_CODE)"
            break
          else
            echo "â³ Backend not ready (HTTP $HTTP_CODE). Attempt $i/30 - waiting 10 seconds..."
            sleep 10
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Backend failed to become healthy"
            exit 1
          fi
        done
      
      # Wait for frontend to be ready
      - echo "â³ Waiting for frontend deployment..."
      - |
        for i in {1..20}; do
          if curl -s -f "$FRONTEND_URL" > /dev/null; then
            echo "âœ… Frontend is accessible!"
            break
          fi
          echo "â³ Frontend not ready. Attempt $i/20 - waiting 15 seconds..."
          sleep 15
          if [ $i -eq 20 ]; then
            echo "âŒ Frontend failed to become accessible"
            exit 1
          fi
        done

  build:
    commands:
      - echo "ğŸ§ª Running Cypress E2E Tests..."
      - cd e2e-tests
      - export CYPRESS_BASE_URL="$FRONTEND_URL"
      - export CYPRESS_API_URL="$BACKEND_API_URL"
      - npm run cypress:run
      
  post_build:
    commands:
      - echo "ğŸ“Š Test Results Summary..."
      - |
        if [ $CODEBUILD_BUILD_SUCCEEDING -eq 1 ]; then
          echo "âœ… All tests passed!"
          # Send success notification to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… E2E Tests Successful! ğŸ‰\\nğŸ“ Build: $CODEBUILD_BUILD_ID\\nğŸŒ Frontend: $FRONTEND_URL\\nğŸ”— Backend: $BACKEND_API_URL\"}" \
            "$SLACK_WEBHOOK_URL"
        else
          echo "âŒ Some tests failed!"
          # Send failure notification to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âŒ E2E Tests Failed!\\nğŸ“ Build: $CODEBUILD_BUILD_ID\\nğŸ” Check: https://console.aws.amazon.com/codesuite/codebuild/projects/$CODEBUILD_PROJECT_NAME/build/$CODEBUILD_BUILD_ID\\nğŸ“¸ Screenshots and videos available in artifacts\"}" \
            "$SLACK_WEBHOOK_URL"
        fi

artifacts:
  files:
    - 'e2e-tests/cypress/reports/**/*'
    - 'e2e-tests/cypress/screenshots/**/*'
    - 'e2e-tests/cypress/videos/**/*'
  name: cypress-test-results-$(date +%Y-%m-%d-%H-%M-%S)
